<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Number System Overview - Interactive Lesson | QLA Mathematics</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

  <!-- KaTeX for Math Rendering -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

  <style>
    :root {
      --maroon: #6C1D45;
      --gold: #C7A34F;
      --success: #10b981;
      --error: #ef4444;
      --info: #3b82f6;
    }
    .section-locked { opacity: 0.5; pointer-events: none; position: relative; }
    .section-locked::after {
      content: ''; position: absolute; inset: 0;
      background: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,0.08) 10px, rgba(0,0,0,0.08) 20px);
      border-radius: 12px;
    }
    .progress-ring { transform: rotate(-90deg); }
    .progress-ring-circle { transition: stroke-dashoffset 0.5s ease; }
    .activity-card { transition: all 0.3s ease; cursor: pointer; }
    .activity-card:hover { transform: translateY(-4px); box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
    .correct-answer { animation: correctPulse 0.5s ease; background: #f0fdf4 !important; border-color: var(--success) !important; }
    .incorrect-answer { animation: shake 0.5s ease; background: #fef2f2 !important; border-color: var(--error) !important; }
    @keyframes correctPulse { 0%,100% {transform:scale(1);} 50% {transform:scale(1.05);} }
    @keyframes shake { 0%,100% {transform:translateX(0);} 25% {transform:translateX(-10px);} 75% {transform:translateX(10px);} }
    .draggable { cursor: move; transition: all 0.2s ease; }
    .draggable.dragging { opacity: 0.5; transform: scale(1.07); }
    .drop-zone { min-height: 72px; border: 2px dashed #cbd5e1; transition: all 0.2s ease; border-radius: 12px; }
    .drop-zone.drag-over { background: #f0f9ff; border-color: var(--info); transform: scale(1.01); }
    .confetti { position: fixed; width: 10px; height: 10px; background: var(--gold); animation: confetti-fall 2.6s ease-out forwards; pointer-events: none; z-index: 1000; }
    @keyframes confetti-fall { to { transform: translateY(100vh) rotate(720deg); opacity: 0; } }
    .video-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; font-weight: bold; pointer-events: none; opacity: 0; transition: opacity 0.3s ease; }
    .video-locked .video-overlay { opacity: 1; pointer-events: auto; }
    .badge { font-size: 0.75rem; font-weight: 700; }
    .katex-block { overflow-x: auto; padding-bottom: 0.25rem; }
    code.k { background: #f8fafc; padding: 0.1rem 0.33rem; border-radius: 4px; }
  </style>
</head>
<body class="bg-gray-50">
  <!-- Header with Progress -->
  <header class="bg-gradient-to-r from-[var(--maroon)] to-[var(--gold)] text-white p-4 sticky top-0 z-40">
    <div class="max-w-7xl mx-auto">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <button onclick="showExitConfirm()" class="bg-white/20 hover:bg-white/30 p-2 rounded-lg transition-colors" aria-label="Exit lesson">
            <i class="fas fa-arrow-left"></i>
          </button>
          <div>
            <h1 class="text-xl font-bold">Number System Overview</h1>
            <p class="text-sm opacity-90">Rational & Irrational • Sets \(\mathbb{N}/\mathbb{W}/\mathbb{Z}/\mathbb{Q}\) • Terminating vs Repeating • Repeats → Fractions</p>
          </div>
        </div>
        <div class="flex items-center gap-6">
          <div class="text-center">
            <div class="text-2xl font-bold">
              <i class="fas fa-star text-yellow-300"></i>
              <span id="totalPoints">0</span>
            </div>
            <div class="text-xs opacity-90">Points</div>
          </div>
          <div class="relative" aria-label="Overall progress">
            <svg width="60" height="60" class="progress-ring" role="img" aria-labelledby="progressLabel">
              <title id="progressLabel">Lesson progress</title>
              <circle cx="30" cy="30" r="25" stroke="white" stroke-width="3" fill="none" opacity="0.3"/>
              <circle id="progressCircle" cx="30" cy="30" r="25" stroke="white" stroke-width="3" fill="none"
                      stroke-dasharray="157" stroke-dashoffset="157" class="progress-ring-circle"/>
            </svg>
            <div class="absolute inset-0 flex items-center justify-center">
              <span id="progressPercent" class="text-sm font-bold">0%</span>
            </div>
          </div>
        </div>
      </div>
      <div class="flex gap-2 mt-4" id="sectionIndicators" aria-label="Section indicators"></div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto p-6">
    <!-- Section 1: Video Introduction -->
    <section id="section-1" class="mb-8" data-type="video" data-points="120">
      <div class="bg-white rounded-xl shadow-lg p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-bold text-[var(--maroon)]">
            <i class="fas fa-play-circle mr-2"></i>
            Video: Rational vs Irrational, Sets & Decimals
          </h2>
          <div class="flex items-center gap-2">
            <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-semibold badge">120 points</span>
            <span id="section-1-status" class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm badge">
              <i class="fas fa-unlock"></i> Available
            </span>
          </div>
        </div>

        <div class="relative aspect-video bg-black rounded-lg overflow-hidden" id="videoContainer">
          <video id="lessonVideo" class="w-full h-full" controls controlsList="nodownload">
            <source src="https://www.w3schools.com/html/mov_bbb.mp4" type="video/mp4">
            Your browser does not support the video tag.
          </video>
          <div class="video-overlay" id="videoOverlay">
            <div class="text-center">
              <i class="fas fa-lock text-4xl mb-2"></i>
              <p>Complete previous sections to unlock</p>
            </div>
          </div>
        </div>

        <div class="mt-4 bg-blue-50 p-4 rounded-lg">
          <p class="text-sm text-blue-800">
            <i class="fas fa-info-circle mr-2"></i>
            Watch at least <strong>85%</strong> of the video (no skipping) to earn 120 points and unlock the next section.
          </p>
          <div class="mt-3">
            <div class="flex justify-between text-sm mb-1">
              <span>Progress</span>
              <span id="videoTime">0:00 / 0:00</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div id="videoProgress" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Section 2: Key Concepts -->
    <section id="section-2" class="mb-8 section-locked" data-type="content" data-points="80">
      <div class="bg-white rounded-xl shadow-lg p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-bold text-[var(--maroon)]">
            <i class="fas fa-book-open mr-2"></i>
            Core Ideas & Notation
          </h2>
          <div class="flex items-center gap-2">
            <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-semibold badge">80 points</span>
            <span id="section-2-status" class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm badge">
              <i class="fas fa-lock"></i> Locked
            </span>
          </div>
        </div>

        <div class="grid md:grid-cols-2 gap-6">
          <!-- Sets -->
          <div class="bg-gradient-to-br from-purple-50 to-pink-50 p-6 rounded-xl">
            <h3 class="text-xl font-bold mb-3 text-purple-900">Number Sets (smallest set idea)</h3>
            <p class="mb-2">We use blackboard letters to denote sets:</p>
            <ul class="space-y-1 ml-4 list-disc">
              <li>\(\mathbb{N}\): natural numbers (we take \(1,2,3,\dots\), <em>no 0</em>).</li>
              <li>\(\mathbb{W}\): whole numbers (\(0,1,2,3,\dots\)).</li>
              <li>\(\mathbb{Z}\): integers (\(\dots,-2,-1,0,1,2,\dots\)).</li>
              <li>\(\mathbb{Q}\): rationals (fractions \(\tfrac{p}{q}\) with \(p,q\in\mathbb{Z}, q\neq 0\)).</li>
              <li>\(\mathbb{R}\): reals (rationals and irrationals).</li>
            </ul>
            <div class="bg-white p-4 rounded-lg mt-3">
              <p class="mb-2">Subset chain:</p>
              <div>\[\mathbb{N} \subset \mathbb{W} \subset \mathbb{Z} \subset \mathbb{Q} \subset \mathbb{R}.\]</div>
              <p class="text-sm text-gray-600">When classifying, choose the <strong>smallest</strong> set containing the number.</p>
            </div>
          </div>

          <!-- Decimals -->
          <div class="bg-gradient-to-br from-blue-50 to-green-50 p-6 rounded-xl">
            <h3 class="text-xl font-bold mb-3 text-blue-900">Decimals: Terminating vs Repeating</h3>
            <p class="mb-2">Every rational number has a decimal that either <strong>terminates</strong> or <strong>repeats</strong>. Irrationals are <em>non‑terminating, non‑repeating</em>.</p>
            <div class="bg-white p-4 rounded-lg">
              <p class="mb-2"><strong>Test for terminating:</strong></p>
              <div>\[\text{In lowest terms } \frac{p}{q} \text{ terminates }\iff q = 2^a 5^b \text{ for some } a,b\in\mathbb{N}_0.\]</div>
              <p class="mt-2 text-sm text-gray-600">Example: \(\tfrac{7}{40}=\tfrac{7}{2^3\cdot 5}\) ⇒ terminates; \(\tfrac{2}{7}\) ⇒ repeats.</p>
            </div>
          </div>
        </div>

        <div class="grid md:grid-cols-2 gap-6 mt-6">
          <!-- Repeats to Fractions -->
          <div class="bg-gradient-to-br from-amber-50 to-yellow-50 p-6 rounded-xl">
            <h3 class="text-xl font-bold mb-3 text-amber-900">Repeating Decimal to Fraction</h3>
            <p class="mb-2">If \(x = I.\,a\overline{b}\) with \(|a|=m\) and \(|b|=n\), then</p>
            <div class="bg-white p-4 rounded-lg">
              <div>\[x = \frac{(I\cdot 10^{m+n}+\overline{a}\cdot 10^n+\overline{b})-(I\cdot 10^m+\overline{a})}{10^{m+n}-10^m}.\]</div>
              <p class="text-sm text-gray-600">This cancels the repeating tail by subtracting two shifts.</p>
            </div>
            <p class="mt-2">Example: \(0.\overline{3}=\tfrac{1}{3}\), \(0.1\overline{6}=\tfrac{1}{6}\), \(2.3\overline{45}=\tfrac{129}{55}\).</p>
          </div>

          <div class="bg-gradient-to-br from-slate-50 to-sky-50 p-6 rounded-xl">
            <h3 class="text-xl font-bold mb-3 text-slate-900">Examples</h3>
            <ul class="space-y-2">
              <li>\(\sqrt{16}=4\in\mathbb{N}\), \(-4\in\mathbb{Z}\).</li>
              <li>\(0.125=\tfrac{1}{8}\in\mathbb{Q}\) (terminating).</li>
              <li>\(0.\overline{3}=\tfrac{1}{3}\in\mathbb{Q}\) (repeating).</li>
              <li>\(\sqrt{2},\,\pi\in\mathbb{R}\setminus\mathbb{Q}\) (irrational).</li>
            </ul>
          </div>
        </div>

        <button onclick="completeReading()" class="mt-6 bg-[var(--maroon)] text-white px-6 py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity">
          <i class="fas fa-check mr-2"></i>I have reviewed the concepts
        </button>
      </div>
    </section>

    <!-- Section 3: Interactive Activities -->
    <section id="section-3" class="mb-8 section-locked" data-type="activity" data-points="200">
      <div class="bg-white rounded-xl shadow-lg p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-bold text-[var(--maroon)]">
            <i class="fas fa-puzzle-piece mr-2"></i>
            Activities: Classify • Decide • Convert
          </h2>
          <div class="flex items-center gap-2">
            <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-semibold badge">200 points</span>
            <span id="section-3-status" class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm badge">
              <i class="fas fa-lock"></i> Locked
            </span>
          </div>
        </div>

        <!-- Activity A: Drag into smallest set -->
        <div class="mb-8 p-4 border-2 border-gray-200 rounded-lg activity-card">
          <h3 class="font-semibold text-lg mb-2">A) Drag each number to the <em>smallest set</em> it belongs to.</h3>
          <div class="flex flex-wrap gap-2 mb-4" id="dragPool">
            <span class="draggable bg-blue-100 px-3 py-1 rounded-lg font-mono" draggable="true" data-tag="N">1</span>
            <span class="draggable bg-blue-100 px-3 py-1 rounded-lg font-mono" draggable="true" data-tag="W">0</span>
            <span class="draggable bg-blue-100 px-3 py-1 rounded-lg font-mono" draggable="true" data-tag="Z">-3</span>
            <span class="draggable bg-blue-100 px-3 py-1 rounded-lg font-mono" draggable="true" data-tag="Q">2/5</span>
            <span class="draggable bg-blue-100 px-3 py-1 rounded-lg font-mono" draggable="true" data-tag="Q">-7/4</span>
            <span class="draggable bg-blue-100 px-3 py-1 rounded-lg font-mono" draggable="true" data-tag="N">4</span>
            <span class="draggable bg-blue-100 px-3 py-1 rounded-lg font-mono" draggable="true" data-tag="I">√2</span>
            <span class="draggable bg-blue-100 px-3 py-1 rounded-lg font-mono" draggable="true" data-tag="I">π</span>
            <span class="draggable bg-blue-100 px-3 py-1 rounded-lg font-mono" draggable="true" data-tag="Q">0.(3)</span>
            <span class="draggable bg-blue-100 px-3 py-1 rounded-lg font-mono" draggable="true" data-tag="Q">0.125</span>
            <span class="draggable bg-blue-100 px-3 py-1 rounded-lg font-mono" draggable="true" data-tag="Z">-4</span>
            <span class="draggable bg-blue-100 px-3 py-1 rounded-lg font-mono" draggable="true" data-tag="I">0.1010010001…</span>
          </div>

          <div class="grid md:grid-cols-5 gap-3">
            <div>
              <div class="text-center font-semibold mb-2">\(\mathbb{N}\)</div>
              <div class="drop-zone p-3 bg-gray-50" data-accept="N" id="zoneN"><p class="text-gray-400 text-center">Drop here</p></div>
            </div>
            <div>
              <div class="text-center font-semibold mb-2">\(\mathbb{W}\)</div>
              <div class="drop-zone p-3 bg-gray-50" data-accept="W" id="zoneW"><p class="text-gray-400 text-center">Drop here</p></div>
            </div>
            <div>
              <div class="text-center font-semibold mb-2">\(\mathbb{Z}\)</div>
              <div class="drop-zone p-3 bg-gray-50" data-accept="Z" id="zoneZ"><p class="text-gray-400 text-center">Drop here</p></div>
            </div>
            <div>
              <div class="text-center font-semibold mb-2">\(\mathbb{Q}\)</div>
              <div class="drop-zone p-3 bg-gray-50" data-accept="Q" id="zoneQ"><p class="text-gray-400 text-center">Drop here</p></div>
            </div>
            <div>
              <div class="text-center font-semibold mb-2">Irrational</div>
              <div class="drop-zone p-3 bg-gray-50" data-accept="I" id="zoneI"><p class="text-gray-400 text-center">Drop here</p></div>
            </div>
          </div>

          <button onclick="checkSetDragDrop(this)" class="mt-3 bg-blue-600 text-white px-4 py-2 rounded-lg">
            Check A (80 pts)
          </button>
          <div id="actAFeedback" class="mt-3"></div>
        </div>

        <!-- Activity B: Terminating or Repeating -->
        <div class="mb-8 p-4 border-2 border-gray-200 rounded-lg activity-card">
          <h3 class="font-semibold text-lg mb-2">B) Decide whether each decimal <span class="font-mono">terminates</span> or <span class="font-mono">repeats</span>.</h3>
          <div id="termRepList" class="grid md:grid-cols-2 gap-3"></div>
          <button onclick="checkTermRep()" class="mt-3 bg-green-600 text-white px-4 py-2 rounded-lg">
            Check B (60 pts)
          </button>
          <div id="actBFeedback" class="mt-3"></div>
        </div>

        <!-- Activity C: Convert Repeats → Fractions -->
        <div class="mb-4 p-4 border-2 border-gray-200 rounded-lg activity-card">
          <h3 class="font-semibold text-lg mb-4">C) Convert each repeating decimal to a fraction (lowest terms).</h3>

          <div class="space-y-4">
            <div class="p-3 rounded-lg bg-amber-50">
              <div class="mb-2"><span class="font-mono">0.(3)</span></div>
              <div class="flex items-center gap-2">
                <input type="number" class="border-2 border-gray-300 rounded-lg px-3 py-2 w-28" id="frac1N" placeholder="Numerator">
                <span>/</span>
                <input type="number" class="border-2 border-gray-300 rounded-lg px-3 py-2 w-28" id="frac1D" placeholder="Denominator">
                <button class="ml-2 bg-amber-600 text-white px-3 py-2 rounded" onclick="checkFraction('frac1', 1, 3)">Check</button>
                <button class="ml-1 text-amber-700 underline" onclick="showSteps('steps1', '0.(3)')">Show steps</button>
              </div>
              <div id="steps1" class="text-sm mt-2 hidden"></div>
            </div>

            <div class="p-3 rounded-lg bg-amber-50">
              <div class="mb-2"><span class="font-mono">0.1(6)</span></div>
              <div class="flex items-center gap-2">
                <input type="number" class="border-2 border-gray-300 rounded-lg px-3 py-2 w-28" id="frac2N" placeholder="Numerator">
                <span>/</span>
                <input type="number" class="border-2 border-gray-300 rounded-lg px-3 py-2 w-28" id="frac2D" placeholder="Denominator">
                <button class="ml-2 bg-amber-600 text-white px-3 py-2 rounded" onclick="checkFraction('frac2', 1, 6)">Check</button>
                <button class="ml-1 text-amber-700 underline" onclick="showSteps('steps2', '0.1(6)')">Show steps</button>
              </div>
              <div id="steps2" class="text-sm mt-2 hidden"></div>
            </div>

            <div class="p-3 rounded-lg bg-amber-50">
              <div class="mb-2"><span class="font-mono">2.3(45)</span></div>
              <div class="flex items-center gap-2">
                <input type="number" class="border-2 border-gray-300 rounded-lg px-3 py-2 w-28" id="frac3N" placeholder="Numerator">
                <span>/</span>
                <input type="number" class="border-2 border-gray-300 rounded-lg px-3 py-2 w-28" id="frac3D" placeholder="Denominator">
                <button class="ml-2 bg-amber-600 text-white px-3 py-2 rounded" onclick="checkFraction('frac3', 129, 55)">Check</button>
                <button class="ml-1 text-amber-700 underline" onclick="showSteps('steps3', '2.3(45)')">Show steps</button>
              </div>
              <div id="steps3" class="text-sm mt-2 hidden"></div>
            </div>
          </div>

          <button onclick="finalizeRepeatsFractions()" class="mt-4 bg-purple-600 text-white px-4 py-2 rounded-lg">
            Check C (60 pts)
          </button>
          <div id="actCFeedback" class="mt-3"></div>
        </div>

        <div id="activityFeedback" class="mt-4"></div>
      </div>
    </section>

    <!-- Section 4: Quiz -->
    <section id="section-4" class="mb-8 section-locked" data-type="quiz" data-points="200">
      <div class="bg-white rounded-xl shadow-lg p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-bold text-[var(--maroon)]">
            <i class="fas fa-clipboard-check mr-2"></i>
            Mastery Quiz
          </h2>
          <div class="flex items-center gap-2">
            <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-semibold badge">200 points</span>
            <span id="section-4-status" class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm badge">
              <i class="fas fa-lock"></i> Locked
            </span>
          </div>
        </div>

        <div class="bg-amber-50 p-4 rounded-lg mb-6">
          <p class="text-amber-800">
            <i class="fas fa-trophy mr-2"></i>Score at least <strong>80%</strong> to complete this section. You can retry if needed.
          </p>
        </div>

        <div class="space-y-6">
          <div class="p-4 bg-gray-50 rounded-lg">
            <h4 class="font-semibold mb-3">1) Which number is irrational?</h4>
            <div class="space-y-2">
              <label class="flex items-center gap-3 cursor-pointer hover:bg-white p-2 rounded"><input type="radio" name="q1" value="a" class="w-4 h-4"> <span>\(\sqrt{2}\)</span></label>
              <label class="flex items-center gap-3 cursor-pointer hover:bg-white p-2 rounded"><input type="radio" name="q1" value="b" class="w-4 h-4"> <span>\(-5\)</span></label>
              <label class="flex items-center gap-3 cursor-pointer hover:bg-white p-2 rounded"><input type="radio" name="q1" value="c" class="w-4 h-4"> <span>\(\tfrac{2}{7}\)</span></label>
              <label class="flex items-center gap-3 cursor-pointer hover:bg-white p-2 rounded"><input type="radio" name="q1" value="d" class="w-4 h-4"> <span>\(0.24\)</span></label>
            </div>
          </div>

          <div class="p-4 bg-gray-50 rounded-lg">
            <h4 class="font-semibold mb-3">2) The smallest set that contains \(-5\) is:</h4>
            <div class="space-y-2">
              <label class="flex items-center gap-3 cursor-pointer hover:bg-white p-2 rounded"><input type="radio" name="q2" value="a"> <span>\(\mathbb{W}\)</span></label>
              <label class="flex items-center gap-3 cursor-pointer hover:bg-white p-2 rounded"><input type="radio" name="q2" value="b"> <span>\(\mathbb{N}\)</span></label>
              <label class="flex items-center gap-3 cursor-pointer hover:bg-white p-2 rounded"><input type="radio" name="q2" value="c"> <span>\(\mathbb{Z}\)</span></label>
              <label class="flex items-center gap-3 cursor-pointer hover:bg-white p-2 rounded"><input type="radio" name="q2" value="d"> <span>\(\mathbb{Q}\)</span></label>
            </div>
          </div>

          <div class="p-4 bg-gray-50 rounded-lg">
            <h4 class="font-semibold mb-3">3) The decimal \(0.\overline{3}\) is:</h4>
            <div class="space-y-2">
              <label class="flex items-center gap-3 cursor-pointer hover:bg-white p-2 rounded"><input type="radio" name="q3" value="a"> <span>Rational, repeating</span></label>
              <label class="flex items-center gap-3 cursor-pointer hover:bg-white p-2 rounded"><input type="radio" name="q3" value="b"> <span>Rational, terminating</span></label>
              <label class="flex items-center gap-3 cursor-pointer hover:bg-white p-2 rounded"><input type="radio" name="q3" value="c"> <span>Irrational</span></label>
              <label class="flex items-center gap-3 cursor-pointer hover:bg-white p-2 rounded"><input type="radio" name="q3" value="d"> <span>Whole</span></label>
            </div>
          </div>

          <div class="p-4 bg-gray-50 rounded-lg">
            <h4 class="font-semibold mb-3">4) Which relation is true?</h4>
            <div class="space-y-2">
              <label class="flex items-center gap-3 cursor-pointer hover:bg-white p-2 rounded"><input type="radio" name="q4" value="a"> <span>\(\mathbb{Q}\subset\mathbb{Z}\)</span></label>
              <label class="flex items-center gap-3 cursor-pointer hover:bg-white p-2 rounded"><input type="radio" name="q4" value="b"> <span>\(\mathbb{N}\subset\mathbb{W}\subset\mathbb{Z}\subset\mathbb{Q}\)</span></label>
              <label class="flex items-center gap-3 cursor-pointer hover:bg-white p-2 rounded"><input type="radio" name="q4" value="c"> <span>\(\mathbb{W}=\mathbb{N}\)</span></label>
              <label class="flex items-center gap-3 cursor-pointer hover:bg-white p-2 rounded"><input type="radio" name="q4" value="d"> <span>\(\mathbb{I}\subset\mathbb{Q}\)</span></label>
            </div>
          </div>

          <div class="p-4 bg-gray-50 rounded-lg">
            <h4 class="font-semibold mb-3">5) Does \(\tfrac{7}{40}\) terminate or repeat?</h4>
            <div class="space-y-2">
              <label class="flex items-center gap-3 cursor-pointer hover:bg-white p-2 rounded"><input type="radio" name="q5" value="a"> <span>Terminates</span></label>
              <label class="flex items-center gap-3 cursor-pointer hover:bg-white p-2 rounded"><input type="radio" name="q5" value="b"> <span>Repeats</span></label>
            </div>
          </div>

          <div class="p-4 bg-gray-50 rounded-lg">
            <h4 class="font-semibold mb-3">6) \(0.1\overline{6}\) equals:</h4>
            <div class="space-y-2">
              <label class="flex items-center gap-3 cursor-pointer hover:bg-white p-2 rounded"><input type="radio" name="q6" value="a"> <span>\(\tfrac{1}{6}\)</span></label>
              <label class="flex items-center gap-3 cursor-pointer hover:bg-white p-2 rounded"><input type="radio" name="q6" value="b"> <span>\(\tfrac{5}{6}\)</span></label>
              <label class="flex items-center gap-3 cursor-pointer hover:bg-white p-2 rounded"><input type="radio" name="q6" value="c"> <span>\(\tfrac{1}{60}\)</span></label>
              <label class="flex items-center gap-3 cursor-pointer hover:bg-white p-2 rounded"><input type="radio" name="q6" value="d"> <span>\(\tfrac{7}{60}\)</span></label>
            </div>
          </div>

          <div class="p-4 bg-gray-50 rounded-lg">
            <h4 class="font-semibold mb-3">7) A number in \(\mathbb{W}\) but not \(\mathbb{N}\) is:</h4>
            <div class="space-y-2">
              <label class="flex items-center gap-3 cursor-pointer hover:bg-white p-2 rounded"><input type="radio" name="q7" value="a"> <span>\(0\)</span></label>
              <label class="flex items-center gap-3 cursor-pointer hover:bg-white p-2 rounded"><input type="radio" name="q7" value="b"> <span>\(1\)</span></label>
              <label class="flex items-center gap-3 cursor-pointer hover:bg-white p-2 rounded"><input type="radio" name="q7" value="c"> <span>\(-1\)</span></label>
              <label class="flex items-center gap-3 cursor-pointer hover:bg-white p-2 rounded"><input type="radio" name="q7" value="d"> <span>\(\tfrac{1}{2}\)</span></label>
            </div>
          </div>

          <div class="p-4 bg-gray-50 rounded-lg">
            <h4 class="font-semibold mb-3">8) Which decimal is non‑terminating and non‑repeating?</h4>
            <div class="space-y-2">
              <label class="flex items-center gap-3 cursor-pointer hover:bg-white p-2 rounded"><input type="radio" name="q8" value="a"> <span>\(0.125\)</span></label>
              <label class="flex items-center gap-3 cursor-pointer hover:bg-white p-2 rounded"><input type="radio" name="q8" value="b"> <span>\(0.\overline{142857}\)</span></label>
              <label class="flex items-center gap-3 cursor-pointer hover:bg-white p-2 rounded"><input type="radio" name="q8" value="c"> <span>\(0.101001000100001\ldots\)</span></label>
              <label class="flex items-center gap-3 cursor-pointer hover:bg-white p-2 rounded"><input type="radio" name="q8" value="d"> <span>\(0.75\)</span></label>
            </div>
          </div>
        </div>

        <div class="mt-6 flex items-center gap-3">
          <button onclick="submitQuiz()" class="bg-[var(--maroon)] text-white px-6 py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity">
            <i class="fas fa-paper-plane mr-2"></i>Submit Quiz
          </button>
          <button onclick="resetQuiz()" class="bg-gray-600 text-white px-4 py-3 rounded-lg font-semibold hover:bg-gray-700">
            <i class="fas fa-redo mr-2"></i>Reset
          </button>
        </div>

        <div id="quizResults" class="mt-6 hidden"></div>
      </div>
    </section>

    <!-- Section 5: Summary and Completion -->
    <section id="section-5" class="mb-8 section-locked" data-type="summary" data-points="0">
      <div class="bg-gradient-to-br from-green-50 to-blue-50 rounded-xl shadow-lg p-8">
        <div class="text-center">
          <div class="text-6xl mb-4">🎉</div>
          <h2 class="text-3xl font-bold text-[var(--maroon)] mb-4">Congratulations!</h2>
          <p class="text-xl mb-6">You've completed <em>Number System Overview</em></p>

          <div class="grid md:grid-cols-3 gap-4 mb-8">
            <div class="bg-white rounded-lg p-4">
              <div class="text-3xl font-bold text-[var(--gold)]" id="finalScore">0</div>
              <div class="text-sm text-gray-600">Total Points</div>
            </div>
            <div class="bg-white rounded-lg p-4">
              <div class="text-3xl font-bold text-[var(--success)]" id="finalGrade">A</div>
              <div class="text-sm text-gray-600">Grade</div>
            </div>
            <div class="bg-white rounded-lg p-4">
              <div class="text-3xl font-bold text-[var(--info)]" id="finalTime">0m</div>
              <div class="text-sm text-gray-600">Time Spent</div>
            </div>
          </div>

          <div class="bg-white rounded-lg p-6 mb-6">
            <h3 class="text-xl font-bold mb-4">What You Mastered</h3>
            <ul class="text-left max-w-2xl mx-auto space-y-2">
              <li><i class="fas fa-check text-green-500 mr-2"></i>Classifying numbers by the <strong>smallest set</strong> \(\mathbb{N}/\mathbb{W}/\mathbb{Z}/\mathbb{Q}/\mathbb{R}\).</li>
              <li><i class="fas fa-check text-green-500 mr-2"></i>Deciding whether a decimal <em>terminates</em> or <em>repeats</em>.</li>
              <li><i class="fas fa-check text-green-500 mr-2"></i>Converting repeating decimals to fractions using an algebraic method.</li>
            </ul>
          </div>

          <div class="flex gap-4 justify-center">
            <button onclick="retryLesson()" class="bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-700">
              <i class="fas fa-redo mr-2"></i>Try Again
            </button>
            <button onclick="completeAndNext()" class="bg-[var(--maroon)] text-white px-6 py-3 rounded-lg font-semibold hover:opacity-90">
              <i class="fas fa-arrow-right mr-2"></i>Mark Complete & Next Lesson
            </button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Exit Confirmation Modal -->
  <div id="exitModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden" role="dialog" aria-modal="true" aria-labelledby="exitTitle">
    <div class="bg-white rounded-xl p-6 max-w-md">
      <h3 id="exitTitle" class="text-xl font-bold mb-4">Leave Lesson?</h3>
      <p class="mb-6">Your progress will be saved, but you'll need to restart this section.</p>
      <div class="flex gap-4">
        <button onclick="closeExitModal()" class="flex-1 bg-gray-200 text-gray-800 px-4 py-2 rounded-lg">Stay</button>
        <button onclick="confirmExit()" class="flex-1 bg-red-600 text-white px-4 py-2 rounded-lg">Leave</button>
      </div>
    </div>
  </div>

  <script>
    // ---------- Lesson State Management ----------
    const lessonState = {
      currentSection: 1,
      totalSections: 5,
      sections: {
        1: { completed: false, points: 0, maxPoints: 120, locked: false },
        2: { completed: false, points: 0, maxPoints: 80, locked: true },
        3: { completed: false, points: 0, maxPoints: 200, locked: true },
        4: { completed: false, points: 0, maxPoints: 200, locked: true },
        5: { completed: false, points: 0, maxPoints: 0, locked: true }
      },
      totalPoints: 0,
      startTime: Date.now(),
      videoWatched: 0,
      activities: {
        A: { checked: false, score: 0, max: 80 },
        B: { checked: false, score: 0, max: 60 },
        C: { checked: false, score: 0, max: 60, subtasksDone: 0 }
      },
      quizAttempts: 0
    };

    // ---------- Initialization ----------
    document.addEventListener('DOMContentLoaded', () => {
      initializeLesson();
      setupVideoTracking();
      setupDragAndDrop();
      buildTermRep();
      renderSectionIndicators();
      updateProgress();
      // KaTeX auto-render
      if (window.renderMathInElement) {
        renderMathInElement(document.body, {
          delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "\\[", right: "\\]", display: true},
            {left: "\\(", right: "\\)", display: false},
            {left: "$", right: "$", display: false}
          ]
        });
      }
    });

    function initializeLesson() {
      sendProgressUpdate('lesson-started', { lessonId: 'number-system-overview' });
      unlockSection(1);
    }

    // ---------- UI Helpers ----------
    function renderSectionIndicators() {
      const container = document.getElementById('sectionIndicators');
      container.innerHTML = '';
      for (let i = 1; i <= lessonState.totalSections; i++) {
        const section = lessonState.sections[i];
        const indicator = document.createElement('div');
        indicator.className = `flex-1 h-2 rounded-full transition-all duration-300 ${ section.completed ? 'bg-white' : section.locked ? 'bg-white/30' : 'bg-white/60' }`;
        container.appendChild(indicator);
      }
    }

    function updateProgress() {
      const maxPoints = Object.values(lessonState.sections).reduce((sum, s) => sum + s.maxPoints, 0);
      const earnedPoints = Object.values(lessonState.sections).reduce((sum, s) => sum + s.points, 0);
      const percentage = maxPoints > 0 ? Math.round((earnedPoints / maxPoints) * 100) : 0;
      lessonState.totalPoints = earnedPoints;

      document.getElementById('totalPoints').textContent = earnedPoints;
      document.getElementById('progressPercent').textContent = percentage + '%';

      const circle = document.getElementById('progressCircle');
      const circumference = 2 * Math.PI * 25;
      const offset = circumference - (percentage / 100) * circumference;
      circle.style.strokeDashoffset = offset;

      renderSectionIndicators();
      sendProgressUpdate('progress-update', { percentage, points: earnedPoints, sections: lessonState.sections });
    }

    function unlockSection(sectionId) {
      const section = document.getElementById(`section-${sectionId}`);
      if (section) {
        section.classList.remove('section-locked');
        lessonState.sections[sectionId].locked = false;
        const statusEl = document.getElementById(`section-${sectionId}-status`);
        if (statusEl) {
          statusEl.innerHTML = '<i class="fas fa-unlock text-yellow-500"></i> Available';
          statusEl.className = 'px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-sm badge';
        }
        if (sectionId === 1) document.getElementById('videoContainer').classList.remove('video-locked');
      }
    }

    function completeSection(sectionId, points = 0) {
      lessonState.sections[sectionId].completed = true;
      lessonState.sections[sectionId].points = points;

      const statusEl = document.getElementById(`section-${sectionId}-status`);
      if (statusEl) {
        statusEl.innerHTML = '<i class="fas fa-check-circle text-green-500"></i> Completed';
        statusEl.className = 'px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm badge';
      }

      if (sectionId < lessonState.totalSections) {
        unlockSection(sectionId + 1);
        setTimeout(() => { document.getElementById(`section-${sectionId + 1}`).scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 800);
      }

      if (sectionId === 4) { completeLessonSummary(); }
      updateProgress();
      createConfetti();
    }

    // ---------- Video Tracking (robust, no-skipping) ----------
    function setupVideoTracking() {
      const video = document.getElementById('lessonVideo');
      if (!video) return;

      let buckets = new Set();           // 1s buckets watched
      const bucketSize = 1;              // seconds
      let maxAllowed = 0;                // furthest time allowed (anti-skip)
      let completed = false;

      video.addEventListener('loadedmetadata', () => {
        document.getElementById('videoTime').textContent = `${formatTime(0)} / ${formatTime(video.duration)}`;
      });

      video.addEventListener('seeking', () => {
        // prevent jumping ahead by more than 3s beyond watched frontier
        if (video.currentTime > maxAllowed + 3) {
          video.currentTime = maxAllowed;
          showNotification('Please watch the video without skipping', 'warning');
        }
      });

      video.addEventListener('timeupdate', () => {
        // record bucket
        const b = Math.floor(video.currentTime / bucketSize);
        buckets.add(b);
        if (video.currentTime > maxAllowed) maxAllowed = video.currentTime;

        const dur = isFinite(video.duration) && video.duration > 0 ? video.duration : 1;
        const totalBuckets = Math.ceil(dur / bucketSize);
        const watchedPercent = Math.min(100, (buckets.size / totalBuckets) * 100);

        document.getElementById('videoProgress').style.width = watchedPercent + '%';
        document.getElementById('videoTime').textContent = `${formatTime(video.currentTime)} / ${formatTime(video.duration)}`;

        lessonState.videoWatched = watchedPercent;

        if (!completed && watchedPercent >= 85) {
          completed = true;
          completeSection(1, 120);
          showNotification('Video completed! +120 points', 'success');
        }
      });

      video.addEventListener('ended', () => {
        if (!lessonState.sections[1].completed) {
          completeSection(1, 120);
          showNotification('Video completed! +120 points', 'success');
        }
      });
    }

    // ---------- Concepts ----------
    function completeReading() {
      if (!lessonState.sections[2].completed) {
        completeSection(2, 80);
        showNotification('Concepts reviewed! +80 points', 'success');
      }
    }

    // ---------- Drag-and-drop (Activity A) ----------
    function setupDragAndDrop() {
      const draggables = document.querySelectorAll('.draggable');
      const dropZones = document.querySelectorAll('.drop-zone');

      draggables.forEach(d => {
        d.addEventListener('dragstart', (e) => {
          e.dataTransfer.setData('text/plain', e.target.textContent.trim());
          e.dataTransfer.setData('tag', e.target.dataset.tag);
          e.target.classList.add('dragging');
        });
        d.addEventListener('dragend', (e) => e.target.classList.remove('dragging'));
      });

      dropZones.forEach(zone => {
        zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('drag-over'); });
        zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
        zone.addEventListener('drop', (e) => {
          e.preventDefault();
          const text = e.dataTransfer.getData('text/plain');
          const tag = e.dataTransfer.getData('tag');
          const pill = document.createElement('span');
          pill.className = 'inline-block bg-blue-100 px-3 py-1 rounded-lg font-mono mx-1 my-1';
          pill.textContent = text;
          pill.dataset.tag = tag;
          pill.title = 'Click to remove';
          pill.onclick = () => pill.remove();
          if (zone.querySelector('.text-gray-400')) zone.innerHTML = '';
          zone.appendChild(pill);
          zone.classList.remove('drag-over');
        });
      });
    }

    function checkSetDragDrop(button) {
      const zones = document.querySelectorAll('.drop-zone');
      let correct = 0, total = 12;
      zones.forEach(zone => {
        const need = zone.dataset.accept;
        zone.querySelectorAll('span').forEach(pill => {
          if (pill.dataset.tag === need) correct++;
        });
      });
      const score = Math.round((correct / total) * 80);
      lessonState.activities.A.checked = true;
      lessonState.activities.A.score = score;
      showNotification(`Activity A score: ${score}/80`, score >= 56 ? 'success' : 'warning');
      document.getElementById('actAFeedback').innerHTML = `
        <div class="${score >= 56 ? 'bg-green-100 text-green-800' : 'bg-amber-100 text-amber-800'} p-3 rounded-lg">
          You placed ${correct} / ${total} correctly. Points awarded: <strong>${score}</strong>.
        </div>`;
      checkActivitiesComplete();
    }

    // ---------- Activity B: Terminating vs Repeating ----------
    const termRepItems = [
      { text: '0.125', kind: 'T', why: 'Denominator 8 = 2^3 → terminates.' },
      { text: '0.(3)', kind: 'R', why: 'Repeating 3 → rational, repeating.' },
      { text: '0.1(6)', kind: 'R', why: 'Repeating 6 after non-repeating 1.' },
      { text: '0.75', kind: 'T', why: 'Denominator 4 = 2^2 → terminates.' },
      { text: '2/7', kind: 'R', why: '7 introduces a prime other than 2 or 5.' },
      { text: '0.(142857)', kind: 'R', why: 'Full repetend 6 digits from 1/7.' },
      { text: '3/40', kind: 'T', why: '40=2^3·5 → terminates.' },
      { text: '0.10', kind: 'T', why: 'Finite decimal.' }
    ];

    function buildTermRep() {
      const host = document.getElementById('termRepList');
      termRepItems.forEach((it, idx) => {
        const row = document.createElement('div');
        row.className = 'flex items-center justify-between bg-white p-3 rounded-lg';
        row.innerHTML = `
          <div class="font-mono text-lg">${it.text}</div>
          <div class="flex gap-2">
            <button class="px-3 py-1 rounded border" data-idx="${idx}" data-ans="T" onclick="markTR(this)">Terminates</button>
            <button class="px-3 py-1 rounded border" data-idx="${idx}" data-ans="R" onclick="markTR(this)">Repeats</button>
          </div>`;
        host.appendChild(row);
      });
    }
    const trResponses = {};
    function markTR(btn) {
      const idx = btn.dataset.idx, ans = btn.dataset.ans;
      trResponses[idx] = ans;
      btn.classList.add('bg-slate-800','text-white');
      btn.parentElement.querySelectorAll('button').forEach(b => { if (b !== btn) b.classList.remove('bg-slate-800','text-white'); });
    }
    function checkTermRep() {
      const total = termRepItems.length;
      let correct = 0;
      for (let i = 0; i < total; i++) if (trResponses[i] === termRepItems[i].kind) correct++;
      const score = Math.round((correct / total) * 60);
      lessonState.activities.B.checked = true;
      lessonState.activities.B.score = score;
      const ok = score >= 42;
      showNotification(`Activity B score: ${score}/60`, ok ? 'success' : 'warning');
      const explain = termRepItems.map((it, i) => {
        const got = trResponses[i] ? (trResponses[i] === 'T' ? 'Terminates' : 'Repeats') : '—';
        const right = it.kind === 'T' ? 'Terminates' : 'Repeats';
        const color = got === right ? 'text-green-700' : 'text-red-700';
        return `<li class="${color}"><span class="font-mono">${it.text}</span>: you → <em>${got}</em>, correct → <em>${right}</em>. <span class="text-slate-600">(${it.why})</span></li>`;
      }).join('');
      document.getElementById('actBFeedback').innerHTML = `
        <div class="${ok ? 'bg-green-100 text-green-800' : 'bg-amber-100 text-amber-800'} p-3 rounded-lg">
          You got ${correct} / ${total}. Points awarded: <strong>${score}</strong>.
          <ul class="mt-2 list-disc ml-5">${explain}</ul>
        </div>`;
      checkActivitiesComplete();
    }

    // ---------- Activity C: Repeating → Fraction ----------
    function gcd(a,b){ a=Math.abs(a); b=Math.abs(b); while(b){ const t=a%b; a=b; b=t; } return a; }
    function showSteps(targetId, text) {
      const el = document.getElementById(targetId);
      let latex = '';
      if (text === '0.(3)') latex = String.raw`Let \ x = 0.\overline{3}. \quad 10x = 3.\overline{3}. \quad 10x - x = 3 \Rightarrow 9x = 3 \Rightarrow x=rac{1}{3}.`;
      else if (text === '0.1(6)') latex = String.raw`Let \ x = 0.1\overline{6}. \ \ 10x = 1.\overline{6}, \ 100x = 16.\overline{6}. \quad 100x-10x = 16-1 = 15 \Rightarrow 90x=15 \Rightarrow x=rac{1}{6}.`;
      else if (text === '2.3(45)') latex = String.raw`Let \ x = 2.3\overline{45}. \ \ 10^3 x = 2345.\overline{45}, \ 10^1 x = 23.\overline{45}. \ (10^3-10^1)x = 2345-23 = 2322 \Rightarrow 990x=2322 \Rightarrow x=rac{2322}{990}=rac{129}{55}.`;
      el.classList.remove('hidden');
      el.innerHTML = '<div>\[' + latex + '\]</div>';
      if (window.renderMathInElement) renderMathInElement(el);
    }
    function checkFraction(prefix, correctN, correctD) {
      const N = parseInt(document.getElementById(prefix + 'N').value);
      const D = parseInt(document.getElementById(prefix + 'D').value);
      if (!N || !D) { showNotification('Enter numerator and denominator', 'warning'); return; }
      const g1 = gcd(N, D);
      const n1 = N / g1, d1 = D / g1;
      const g2 = gcd(correctN, correctD);
      const n2 = correctN / g2, d2 = correctD / g2;
      const ok = (n1 === n2 && d1 === d2);
      const inputs = [document.getElementById(prefix + 'N'), document.getElementById(prefix + 'D')];
      if (ok) {
        inputs.forEach(i => { i.classList.add('correct-answer'); i.disabled = true; });
        lessonState.activities.C.subtasksDone++;
        showNotification('Correct fraction!', 'success');
      } else {
        inputs.forEach(i => { i.classList.add('incorrect-answer'); setTimeout(() => i.classList.remove('incorrect-answer'), 500); });
        showNotification('Not quite. Reduce to lowest terms and try again.', 'error');
      }
    }
    function finalizeRepeatsFractions() {
      const total = 3;
      const done = lessonState.activities.C.subtasksDone;
      const score = Math.round((done / total) * 60);
      lessonState.activities.C.checked = true;
      lessonState.activities.C.score = score;
      document.getElementById('actCFeedback').innerHTML = `
        <div class="${score >= 42 ? 'bg-green-100 text-green-800' : 'bg-amber-100 text-amber-800'} p-3 rounded-lg">
          You completed ${done} / ${total}. Points awarded: <strong>${score}</strong>.
        </div>`;
      checkActivitiesComplete();
    }
    function checkActivitiesComplete() {
      const A = lessonState.activities.A.score;
      const B = lessonState.activities.B.score;
      const C = lessonState.activities.C.score;
      const allChecked = lessonState.activities.A.checked && lessonState.activities.B.checked && lessonState.activities.C.checked;
      if (allChecked && !lessonState.sections[3].completed) {
        const total = A + B + C;
        completeSection(3, total);
        document.getElementById('activityFeedback').innerHTML = `
          <div class="bg-green-100 text-green-800 p-4 rounded-lg">
            <i class="fas fa-trophy mr-2"></i>
            All activities completed! Earned <strong>${total}</strong> points.
          </div>`;
      }
      updateProgress();
    }

    // ---------- Quiz ----------
    function submitQuiz() {
      const answers = {
        q1: document.querySelector('input[name="q1"]:checked')?.value,
        q2: document.querySelector('input[name="q2"]:checked')?.value,
        q3: document.querySelector('input[name="q3"]:checked')?.value,
        q4: document.querySelector('input[name="q4"]:checked')?.value,
        q5: document.querySelector('input[name="q5"]:checked')?.value,
        q6: document.querySelector('input[name="q6"]:checked')?.value,
        q7: document.querySelector('input[name="q7"]:checked')?.value,
        q8: document.querySelector('input[name="q8"]:checked')?.value
      };
      const correctAnswers = { q1: 'a', q2: 'c', q3: 'a', q4: 'b', q5: 'a', q6: 'a', q7: 'a', q8: 'c' };
      const explanations = {
        q1: '√2 is not a ratio of integers; it is irrational.',
        q2: '−5 is an integer, so the smallest set is ℤ.',
        q3: '0.(3) = 1/3, a rational repeating decimal.',
        q4: 'Correct chain is ℕ ⊂ 𝕎 ⊂ ℤ ⊂ ℚ.',
        q5: '7/40 has denominator 2^3·5; terminates.',
        q6: 'Let x=0.1(6); 100x−10x=15 ⇒ x=1/6.',
        q7: '0 is whole but not natural (with our convention).',
        q8: 'Pattern grows without a repeating block ⇒ irrational.'
      };
      let correct = 0;
      const totalQuestions = 8, pointsPerQuestion = 25;
      Object.keys(answers).forEach(q => {
        const chosen = answers[q], right = correctAnswers[q];
        if (chosen === right) {
          correct++;
          document.querySelector(`input[name="${q}"][value="${chosen}"]`)?.closest('label').classList.add('correct-answer');
        } else {
          if (chosen) document.querySelector(`input[name="${q}"][value="${chosen}"]`)?.closest('label').classList.add('incorrect-answer');
          document.querySelector(`input[name="${q}"][value="${right}"]`)?.closest('label').classList.add('correct-answer');
        }
      });
      const scorePct = Math.round((correct / totalQuestions) * 100);
      const points = correct * pointsPerQuestion;
      lessonState.quizAttempts++;
      const resultsDiv = document.getElementById('quizResults');
      resultsDiv.classList.remove('hidden');
      if (scorePct >= 80) {
        resultsDiv.innerHTML = `<div class="bg-green-100 text-green-800 p-4 rounded-lg"><i class="fas fa-check-circle mr-2"></i><strong>Excellent!</strong> You scored ${scorePct}% (${correct}/${totalQuestions}).<br>You earned ${points} points.</div>`;
        if (!lessonState.sections[4].completed) { lessonState.sections[4].points = points; completeSection(4, points); }
      } else {
        const explainList = Object.keys(correctAnswers).map(q => {
          const letter = correctAnswers[q].toUpperCase();
          return `<li><strong>${q.toUpperCase()}</strong> → ${letter}. <span class="text-slate-600">${explanations[q] || ''}</span></li>`;
        }).join('');
        resultsDiv.innerHTML = `<div class="bg-amber-100 text-amber-800 p-4 rounded-lg"><i class="fas fa-exclamation-triangle mr-2"></i>You scored ${scorePct}% (${correct}/${totalQuestions}). Need ≥ 80% to pass.<details class="mt-2"><summary class="cursor-pointer font-semibold">See answers & explanations</summary><ul class="mt-2 list-disc ml-6">${explainList}</ul></details></div>`;
      }
      updateProgress();
    }
    function resetQuiz() {
      document.querySelectorAll('input[type="radio"]').forEach(input => {
        input.checked = false;
        input.closest('label').classList.remove('correct-answer', 'incorrect-answer');
      });
      document.getElementById('quizResults').classList.add('hidden');
    }

    // ---------- Completion ----------
    function completeLessonSummary() {
      unlockSection(5);
      const timeSpent = Math.round((Date.now() - lessonState.startTime) / 60000);
      const totalPoints = lessonState.totalPoints;
      const maxPoints = Object.values(lessonState.sections).reduce((s, v) => s + v.maxPoints, 0);
      const percentage = Math.round((totalPoints / maxPoints) * 100);
      let grade = 'F';
      if (percentage >= 97) grade = 'A+';
      else if (percentage >= 90) grade = 'A';
      else if (percentage >= 85) grade = 'B+';
      else if (percentage >= 80) grade = 'B';
      else if (percentage >= 70) grade = 'C';
      document.getElementById('finalScore').textContent = totalPoints;
      document.getElementById('finalGrade').textContent = grade;
      document.getElementById('finalTime').textContent = timeSpent + 'm';
      setTimeout(() => { document.getElementById('section-5').scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 800);
      sendProgressUpdate('lesson-complete', { lessonId: 'number-system-overview', score: totalPoints, grade: grade, timeSpent: timeSpent, attempts: lessonState.quizAttempts });
      for (let i = 0; i < 5; i++) setTimeout(() => createConfetti(), i * 200);
    }
    function completeAndNext() { sendProgressUpdate('complete-next', { lessonId: 'number-system-overview' }); window.location.href = '/portal/student#next-lesson'; }

    // ---------- Utility ----------
    function formatTime(seconds) {
      if (!isFinite(seconds)) return '0:00';
      const m = Math.floor(seconds / 60) || 0;
      const s = Math.floor(seconds % 60) || 0;
      return `${m}:${s.toString().padStart(2, '0')}`;
    }
    function showNotification(message, type = 'info') {
      const colors = { success: 'bg-green-100 text-green-800 border-green-300', error: 'bg-red-100 text-red-800 border-red-300', warning: 'bg-yellow-100 text-yellow-800 border-yellow-300', info: 'bg-blue-100 text-blue-800 border-blue-300' };
      const icon = type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-circle' : 'info-circle';
      const notification = document.createElement('div');
      notification.className = `fixed top-20 right-4 p-4 rounded-lg border-2 ${colors[type]} z-50 shadow-lg`;
      notification.innerHTML = `<i class="fas fa-${icon} mr-2"></i>${message}`;
      document.body.appendChild(notification);
      setTimeout(() => { notification.style.opacity = '0'; setTimeout(() => notification.remove(), 300); }, 2800);
    }
    function createConfetti() {
      const colors = ['#6C1D45', '#C7A34F', '#10b981', '#3b82f6', '#ef4444'];
      for (let i = 0; i < 24; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = Math.random() * 100 + '%';
        confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.animationDelay = Math.random() * 0.4 + 's';
        confetti.style.animationDuration = (Math.random() * 0.8 + 2.2) + 's';
        document.body.appendChild(confetti);
        setTimeout(() => confetti.remove(), 3000);
      }
    }
    function sendProgressUpdate(type, data) {
      if (window.parent && window.parent !== window) window.parent.postMessage({ type: type, timestamp: Date.now(), ...data }, '*');
      fetch('/api/interactive/progress', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ lessonId: 'number-system-overview', eventType: type, data: data }) }).catch(() => {});
    }

    // ---------- Exit & Navigation ----------
    function showExitConfirm() { document.getElementById('exitModal').classList.remove('hidden'); }
    function closeExitModal() { document.getElementById('exitModal').classList.add('hidden'); }
    function confirmExit() { sendProgressUpdate('lesson-exit', { lessonId: 'number-system-overview', progress: lessonState }); window.location.href = '/portal/student'; }
    function retryLesson() { location.reload(); }
  </script>
</body>
</html>
