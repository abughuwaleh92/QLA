<!DOCTYPE html>
<html lang="en"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>QLA Mathematics — Student Portal</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Poppins:wght@600;800&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
<link rel="icon" type="image/png" href="/assets/logo/qla-favicon.png"/>
<script src="/socket.io/socket.io.js"></script>
<style>
:root{ --maroon:#6C1D45; --maroon2:#8B2450; --gold:#C7A34F; --gold2:#E4D4A8; --ink:#0F172A; --slate:#5b6572; --line:#e9eef2; --bg:#F7FAFC; --ok:#136f3a; --soon:#8a3d00; --purple:#7C3AED; --blue:#1D4ED8; }
*{box-sizing:border-box} html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.5}
.hero{position:relative;color:#fff;background:linear-gradient(135deg,rgba(108,29,69,.88),rgba(139,36,80,.84))} 
.logo-tile{background:#fff;border:1px solid var(--line);border-radius:16px;padding:8px 10px;display:inline-flex;align-items:center;justify-content:center;box-shadow:0 10px 24px rgba(0,0,0,.08)}
.nav-tabs{ display:flex; gap:8px; background:rgba(255,255,255,.14); border:1px solid rgba(255,255,255,.35); border-radius:14px; padding:6px; flex-wrap:wrap }
.nav-tab{ flex:1; min-width:120px; padding:10px 14px; border-radius:10px; border:1px solid rgba(255,255,255,.35); color:#fff; background:transparent; cursor:pointer; font-weight:600; text-align:center; transition:all .3s ease }
.nav-tab.active{ background:linear-gradient(135deg,var(--gold),var(--gold2)); color:var(--maroon); transform:scale(1.02) }
.card{ background:#fff; border:1px solid var(--line); border-radius:18px; transition:all .3s ease } .card:hover{ transform:translateY(-2px); box-shadow:0 20px 40px rgba(0,0,0,.1) }
.interactive-row{ border:1px solid var(--line); border-radius:12px; padding:12px 16px; display:flex; align-items:center; justify-content:space-between; gap:12px; background:#fff; transition:all .3s ease; cursor:pointer; position:relative; overflow:hidden }
.interactive-row::before{ content:""; position:absolute; left:-100%; top:0; bottom:0; width:4px; background:linear-gradient(135deg,var(--gold),var(--maroon)); transition:left .3s ease }
.interactive-row:hover{ transform:translateX(4px); box-shadow:0 12px 28px rgba(0,0,0,.08) } .interactive-row:hover::before{ left:0 }
.status{font-size:11px; padding:6px 12px; border-radius:999px; border:1px solid transparent; text-transform:uppercase; letter-spacing:.3px; font-weight:600}
.open{ background:rgba(19,111,58,.1); color:var(--ok); border-color:rgba(19,111,58,.25) }
.modal{ position:fixed; inset:0; background:rgba(0,0,0,.5); backdrop-filter:blur(8px); z-index:1000; display:flex; align-items:center; justify-content:center; opacity:0; pointer-events:none; transition:all .3s ease }
.modal.show{ opacity:1; pointer-events:auto } .modal-content{ background:#fff; border-radius:20px; max-width:90vw; max-height:90vh; overflow:auto; box-shadow:0 25px 50px rgba(0,0,0,.25) }
.progress-bar{ height:6px; background:#e5e7eb; border-radius:3px; overflow:hidden } .progress-fill{ height:100%; background:linear-gradient(90deg,var(--gold),var(--maroon)); transition:width .5s ease }
iframe.lesson-frame{width:100%;height:65vh;border:1px solid var(--line);border-radius:14px}
.logo-header { display: flex; align-items: center; gap: 16px; }
.school-logo { height: 64px; width: auto; filter: brightness(0) invert(1); }
.school-logo-fallback { background: white; border-radius: 12px; padding: 12px; }
</style>
</head>
<body>
<header class="hero shadow-2xl">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex items-center justify-between py-6">
      <div class="logo-header">
        <!-- School Logo -->
        <img src="/assets/logo/qla-logo.png" alt="Qatar Leadership Academy" class="school-logo"
             onerror="this.style.display='none'; document.getElementById('logo-fallback').style.display='block';">
        <span id="logo-fallback" class="logo-tile" style="display:none;">
          <div class="w-16 h-16 bg-[var(--maroon)] rounded-lg flex items-center justify-center text-white font-bold text-xl">QLA</div>
        </span>
        <div>
          <h1 class="text-3xl lg:text-5xl font-extrabold" style="font-family:Poppins,Inter,sans-serif">Mathematics Portal</h1>
          <p class="text-sm opacity-90 mt-1">Qatar Leadership Academy • Student Portal</p>
        </div>
      </div>
      <div id="userBadge" class="hidden lg:flex items-center gap-4">
        <div class="bg-white/10 backdrop-blur rounded-full p-2"><i class="fas fa-user-circle text-2xl"></i></div>
        <div class="text-right">
          <div class="font-semibold">Student</div>
          <div class="text-xs opacity-80">Welcome</div>
        </div>
      </div>
    </div>
    <div class="pb-6 flex flex-col gap-4">
      <div class="nav-tabs" role="tablist">
        <button class="nav-tab active" data-tab="dashboard"><i class="fas fa-home mr-2"></i>Dashboard</button>
        <button class="nav-tab" data-tab="lessons"><i class="fas fa-book mr-2"></i>Lessons</button>
        <button class="nav-tab" data-tab="practice"><i class="fas fa-dumbbell mr-2"></i>Practice</button>
        <button class="nav-tab" data-tab="assessments"><i class="fas fa-clipboard-check mr-2"></i>Assessments</button>
        <button class="nav-tab" data-tab="progress"><i class="fas fa-chart-line mr-2"></i>Progress</button>
        <a class="nav-tab" href="#" onclick="logout()"><i class="fas fa-sign-out-alt mr-2"></i>Sign out</a>
      </div>
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4"><select id="gradeSelect" class="bg-white/10 border border-white/20 text-white rounded-lg px-3 py-2 font-semibold"><option value="7">Grade 7</option><option value="8">Grade 8</option></select></div>
        <div class="hidden sm:flex items-center gap-4 bg-white/10 rounded-2xl px-4 py-2"><div class="flex items-center gap-2"><span class="kbd">/</span><span class="text-xs">Search</span></div><div class="flex items-center gap-2"><span class="kbd">G</span><span class="text-xs">Switch Grade</span></div></div>
      </div>
    </div>
  </div>
</header>

<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <section id="dashboard-tab" class="tab-content">
    <div class="grid gap-6 md:grid-cols-3 mb-8">
      <div class="card p-6 text-center"><div class="w-16 h-16 rounded-full bg-gradient-to-r from-[var(--gold)] to-[var(--maroon)] mx-auto mb-4 flex items-center justify-center text-white text-2xl font-bold"><span id="overallProgress">0%</span></div><h3 class="font-bold text-lg mb-2">Overall Progress</h3><div class="progress-bar"><div class="progress-fill" id="overallProgressBar" style="width:0%"></div></div></div>
      <div class="card p-6 text-center"><div class="w-16 h-16 rounded-full bg-[var(--ok)] mx-auto mb-4 flex items-center justify-center text-white"><i class="fas fa-trophy text-2xl"></i></div><h3 class="font-bold text-lg mb-2">Completed Lessons</h3><div class="text-3xl font-bold text-[var(--ok)]" id="completedCount">0</div></div>
      <div class="card p-6 text-center"><div class="w-16 h-16 rounded-full bg-[var(--blue)] mx-auto mb-4 flex items-center justify-center text-white"><i class="fas fa-clock text-2xl"></i></div><h3 class="font-bold text-lg mb-2">Study Time</h3><div class="text-3xl font-bold text-[var(--blue)]" id="studyTime">0h</div></div>
    </div>
    <section class="card p-6 mb-8"><h3 class="font-bold text-xl mb-4"><i class="fas fa-bolt mr-2 text-[var(--gold)]"></i>Quick Actions</h3>
      <div class="grid gap-4 md:grid-cols-4">
        <button class="interactive-row justify-center" onclick="continueLastLesson()"><i class="fas fa-play mr-2"></i>Continue Learning</button>
        <button class="interactive-row justify-center" onclick="startPractice()"><i class="fas fa-dumbbell mr-2"></i>Practice Problems</button>
        <button class="interactive-row justify-center" onclick="takeAssessment()"><i class="fas fa-clipboard-check mr-2"></i>Take Assessment</button>
        <button class="interactive-row justify-center" onclick="viewProgress()"><i class="fas fa-chart-line mr-2"></i>View Progress</button>
      </div>
    </section>
  </section>

  <section id="lessons-tab" class="tab-content hidden">
    <div class="card p-5 mb-6"><label class="block text-sm font-semibold text-slate-700 mb-2"><i class="fas fa-search mr-2"></i>Search lessons</label>
      <div class="relative"><input id="lessonSearch" type="search" placeholder="e.g., Fractions, BIDMAS, Pythagoras, Geometry" class="w-full rounded-xl border border-[var(--line)] pl-10 pr-3 py-3 focus:outline-none focus:border-[var(--gold)] focus:ring-2 focus:ring-[var(--gold)]/20"/><i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i></div>
    </div>
    <div id="lessonsContent"></div>
  </section>

  <section id="assessments-tab" class="tab-content hidden">
    <div class="grid gap-6">
      <div class="card p-6"><div class="flex items-center justify-between mb-4">
        <h3 class="font-bold text-xl"><i class="fas fa-clipboard-check mr-2 text-[var(--maroon)]"></i>Available Assessments</h3>
        <div class="text-sm text-slate-600">Assessments appear after you open a lesson.</div></div>
        <div id="assessmentsList" class="space-y-3"></div>
      </div>
    </div>
  </section>

  <section id="practice-tab" class="tab-content hidden"><div class="card p-6 text-slate-600">Practice modules coming from your teacher.</div></section>
  <section id="progress-tab" class="tab-content hidden">
    <div class="grid gap-6">
      <div class="card p-6"><h3 class="font-bold text-xl mb-4"><i class="fas fa-chart-line mr-2 text-[var(--gold)]"></i>Your Learning Journey</h3>
        <div id="progressChart" class="h-64 bg-gray-50 rounded-lg flex items-center justify-center"><p class="text-gray-500">Progress visualization will appear here</p></div></div>
    </div>
  </section>
  <footer class="mt-12 mb-8 text-center">
    <!-- Footer with Logo -->
    <div class="flex items-center justify-center gap-3 mb-4">
      <img src="/assets/logo/qla-logo.png" alt="QLA" class="h-8 w-auto opacity-50"
           onerror="this.style.display='none'">
      <p class="text-sm text-slate-500">© <span id="year"></span> Qatar Leadership Academy — Member of Qatar Foundation</p>
    </div>
  </footer>
</main>

<div id="lessonModal" class="modal"><div class="modal-content w-full max-w-5xl mx-4"><div class="p-6">
  <div class="flex items-center justify-between mb-3"><h2 id="lessonTitle" class="text-2xl font-bold"></h2><button onclick="closeLessonModal()" class="text-gray-500 hover:text-gray-700 text-2xl"><i class="fas fa-times"></i></button></div>
  <div class="mb-4"><div class="progress-bar"><div class="progress-fill" id="lessonProgressFill" style="width:0%"></div></div></div>
  <iframe id="lessonFrame" class="lesson-frame" src="about:blank"></iframe>
  <div class="flex justify-between mt-4">
    <button id="prevLessonBtn" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors"><i class="fas fa-arrow-left mr-2"></i>Previous</button>
    <div class="space-x-2">
      <button id="markCompleteBtn" class="bg-[var(--ok)] text-white px-6 py-2 rounded-lg hover:opacity-80 transition-opacity"><i class="fas fa-check mr-2"></i>Mark Complete</button>
      <button id="nextLessonBtn" class="bg-[var(--maroon)] text-white px-6 py-2 rounded-lg hover:bg-[var(--maroon2)] transition-colors">Next<i class="fas fa-arrow-right ml-2"></i></button>
    </div>
  </div>
  <div class="mt-6"><button id="startAssessmentBtn" class="bg-[var(--blue)] text-white px-4 py-2 rounded">Start Assessment</button></div>
</div></div></div>

<script>
const socket = typeof io !== 'undefined' ? io() : null;
const userData = { currentGrade:7, lastLesson:null };
let currentLessonId = null, currentAssessmentId = null;

function show(message,type='info'){
  const n = document.createElement('div');
  n.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg text-white font-semibold transition-all duration-300 transform translate-x-full`;
  const colors = { success:'bg-[var(--ok)]', error:'bg-red-600', info:'bg-[var(--blue)]', warning:'bg-[var(--soon)]' };
  n.classList.add(colors[type]||colors.info); n.textContent = message; document.body.appendChild(n);
  setTimeout(()=>n.classList.remove('translate-x-full'),100); setTimeout(()=>{ n.classList.add('translate-x-full'); setTimeout(()=>n.remove(),300); },3000);
}
async function api(p,opts){ const r = await fetch(p, Object.assign({ headers:{'Content-Type':'application/json'} }, opts||{})); if (!r.ok) throw new Error(await r.text()); return r.json(); }
async function me(){ const r = await api('/api/auth/me').catch(()=>({user:null})); const ub = document.getElementById('userBadge'); if (r.user){ ub.classList.remove('hidden'); ub.querySelector('.font-semibold').textContent = r.user.role==='teacher'?'Teacher':'Student'; ub.querySelector('.text-xs').textContent = r.user.email; } }
function setup(){
  me();
  document.querySelectorAll('.nav-tab').forEach(tab=>tab.addEventListener('click',()=>switchTab(tab.dataset.tab)));
  document.getElementById('gradeSelect').addEventListener('change', e=>{ userData.currentGrade=parseInt(e.target.value); renderLessons(); });
  document.getElementById('lessonSearch').addEventListener('input', e=>filterLessons(e.target.value));
  window.addEventListener('message', ev=>{
    if (!ev.data || ev.data.type!=='lesson-progress') return;
    if (ev.data.total) {
      const pct = Math.max(0, Math.min(100, Math.round(ev.data.slide/ev.data.total*100)));
      document.getElementById('lessonProgressFill').style.width = pct+'%';
    }
    try{ fetch('/api/progress/event',{ method:'POST', body: JSON.stringify({ lessonId: currentLessonId, slide: ev.data.slide, total: ev.data.total, extra: { maybeCorrect: ev.data.maybeCorrect||false } }), headers:{'Content-Type':'application/json'} }); } catch(_){}
  });
  document.getElementById('startAssessmentBtn').addEventListener('click', startAssessment);
  document.getElementById('markCompleteBtn').addEventListener('click', () => {
    if (!currentLessonId) return;
    fetch('/api/progress/complete', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ lessonId: currentLessonId }) });
    show('Lesson completed! 🎉','success'); closeLessonModal();
  });
  document.getElementById('year').textContent = new Date().getFullYear();
  renderLessons();
}
function switchTab(tab){ document.querySelectorAll('.nav-tab').forEach(b=>b.classList.toggle('active', b.dataset.tab===tab)); document.querySelectorAll('.tab-content').forEach(c=>c.classList.toggle('hidden', !c.id.startsWith(tab))); if (tab==='assessments') loadAssessments(); }
async function renderLessons(){
  const r = await api('/api/lessons/catalog?grade='+userData.currentGrade).catch(()=>({units:[]}));
  const container = document.getElementById('lessonsContent'); container.innerHTML='';
  for (const [i,unit] of (r.units||[]).entries()){
    const unitDiv = document.createElement('div');
    unitDiv.className='card p-5 mb-5';
    unitDiv.innerHTML = `<div class="flex items-center gap-3 mb-4"><div class="rounded-xl bg-[var(--maroon)] text-white w-12 h-12 flex items-center justify-center text-xl font-bold">${unit.num||i+1}</div><div><h3 class="font-bold text-lg">${unit.name}</h3><div class="text-sm text-gray-600">${(unit.lessons||[]).length} lesson(s)</div></div></div><div class="grid gap-3 md:grid-cols-2 lg:grid-cols-3" id="unit-${i}-lessons"></div>`;
    container.appendChild(unitDiv);
    const lc = unitDiv.querySelector(`#unit-${i}-lessons`);
    (unit.lessons||[]).forEach(L=>{
      const div=document.createElement('div'); div.className='interactive-row'; div.onclick = ()=>openLesson(`${L.grade}-${L.unit}-${L.order}`, L.title, L.src);
      div.innerHTML = `<div class="flex-1"><div class="font-semibold text-sm">${L.title}</div></div><span class="status open">Start</span>`; lc.appendChild(div);
    });
  }
}
function filterLessons(q){ document.querySelectorAll('#lessonsContent .interactive-row').forEach(l=>{ const m = l.textContent.toLowerCase().includes(q.toLowerCase()); l.style.display = m?'':'none'; }); }
async function openLesson(lessonId, title, src){
  currentLessonId = lessonId; userData.lastLesson = { lessonId, title };
  document.getElementById('lessonTitle').textContent = title;
  const frame = document.getElementById('lessonFrame'); frame.src='about:blank';
  document.getElementById('lessonProgressFill').style.width='0%';
  document.getElementById('lessonModal').classList.add('show');
  frame.onload = ()=>{ try{ const s = frame.contentDocument.createElement('script'); s.src='/js/lesson-bridge.js'; frame.contentDocument.head.appendChild(s); } catch(e){} };
  const [g,u,o] = lessonId.split('-'); const resolved = await api(`/api/lessons/resolve?grade=${g}&unit=${u}&order=${o}`).catch(()=>({src:'/lessons/grade'+userData.currentGrade+'/welcome.html'})); frame.src = src || resolved.src;
  loadAssessments(lessonId);
}
function closeLessonModal(){ document.getElementById('lessonModal').classList.remove('show'); }
async function loadAssessments(lessonId){
  const l = lessonId || currentLessonId; if (!l) return;
  const idParts = l.split('-'); const grade = parseInt(idParts[0]); const unit = parseInt(idParts[1]); const order = parseInt(idParts[2]);
  const list = document.getElementById('assessmentsList'); list.innerHTML = '<div class="text-sm text-slate-600">Loading…</div>';
  try {
    const cat = await api('/api/lessons/catalog?grade='+grade);
    let dbId = null;
    for (const u of (cat.units||[])) if (u.num==unit) { const found = (u.lessons||[]).find(x=>x.order==order); dbId = found?.id; break; }
    if (!dbId){ list.innerHTML = '<div class="text-sm text-slate-600">No assessments yet.</div>'; return; }
    const arr = await api('/api/assessments/for-lesson?lesson_id='+dbId);
    if (!arr.length){ list.innerHTML = '<div class="text-sm text-slate-600">No assessments yet.</div>'; return; }
    list.innerHTML = arr.map(a=>`<div class="interactive-row" onclick="beginAssessment(${a.id})"><div class="flex-1"><div class="font-semibold">${a.title}</div><div class="text-xs text-slate-600">${a.num_questions} question(s) • pass ${a.pass_pct}%</div></div><span class="status open">Take</span></div>`).join('');
    currentAssessmentId = arr[0].id;
  } catch(e){ list.innerHTML = '<div class="text-sm text-slate-600">No assessments found.</div>'; }
}
async function beginAssessment(id){ currentAssessmentId = id; closeLessonModal(); switchTab('assessments'); show('Assessment loaded','success'); }
async function startAssessment(){ if (!currentAssessmentId){ show('No assessment bound to this lesson yet.','warning'); return; } const a = await api('/api/assessments/'+currentAssessmentId); renderAssessment(a); }
function renderAssessment(a){
  const cont = document.getElementById('assessmentsList'); cont.innerHTML = '';
  const form = document.createElement('div'); form.className='space-y-3';
  a.questions.forEach(q=>{
    const card = document.createElement('div'); card.className='card p-4';
    card.innerHTML = `<div class="font-semibold mb-2">${q.prompt}</div><div class="space-y-2" id="q-${q.id}"></div>`;
    const holder = card.querySelector(`#q-${q.id}`);
    if (q.type==='mcq' || q.type==='tf'){
      (q.options||[]).forEach((opt,i)=>{ const btn=document.createElement('button'); btn.className='interactive-row'; btn.textContent=opt; btn.onclick=()=>{ holder.querySelectorAll('button').forEach(b=>b.classList.remove('completed')); btn.classList.add('completed'); btn.dataset.value=String(i); }; holder.appendChild(btn); });
    } else if (q.type==='multi'){
      (q.options||[]).forEach((opt,i)=>{ const btn=document.createElement('button'); btn.className='interactive-row'; btn.textContent=opt; btn.onclick=()=>{ btn.classList.toggle('completed'); }; btn.dataset.index=i; holder.appendChild(btn); });
    } else if (q.type==='num'){
      holder.innerHTML = `<input type="number" step="any" class="rounded border px-3 py-2" placeholder="Your answer"/>`;
    } else if (q.type==='text'){
      holder.innerHTML = `<input type="text" class="rounded border px-3 py-2" placeholder="Your answer"/>`;
    }
    form.appendChild(card);
  });
  const submit = document.createElement('button'); submit.className='bg-[var(--maroon)] text-white px-4 py-2 rounded'; submit.textContent='Submit';
  submit.onclick = async ()=>{
    const answers = a.questions.map(q=>{
      const holder = document.getElementById('q-'+q.id);
      if (q.type==='mcq' || q.type==='tf'){ const chosen = holder.querySelector('button.completed'); return { question_id:q.id, value: chosen ? parseInt(chosen.dataset.value) : null }; }
      if (q.type==='multi'){ const chosen = Array.from(holder.querySelectorAll('button.completed')).map(b=>parseInt(b.dataset.index)); return { question_id:q.id, value: chosen }; }
      if (q.type==='num'){ return { question_id:q.id, value: parseFloat(holder.querySelector('input').value) }; }
      if (q.type==='text'){ return { question_id:q.id, value: holder.querySelector('input').value }; }
      return { question_id:q.id, value:null };
    });
    const r = await api('/api/assessments/'+a.assessment.id+'/submit', { method:'POST', body: JSON.stringify({ answers }) });
    show(`Score: ${r.score_pct}% ${r.passed?'✅ Passed':'❌ Not passed'}`, r.passed?'success':'warning');
  };
  form.appendChild(submit);
  cont.appendChild(form);
}
async function logout(){ await fetch('/auth/logout', { method:'POST' }); location.href='/login'; }
document.addEventListener('DOMContentLoaded', setup);
</script>
</body></html>
