<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>QLA Mathematics — Teacher Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Poppins:wght@600;800&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    :root{ --maroon:#6C1D45; --maroon2:#8B2450; --gold:#C7A34F; --gold2:#E4D4A8; --ink:#0F172A; --slate:#5b6572; --line:#e9eef2; --bg:#F7FAFC; --ok:#136f3a; --soon:#8a3d00; --purple:#7C3AED; --blue:#1D4ED8; }
    *{box-sizing:border-box} html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.5}
    .hero{position:relative;color:#fff;background:linear-gradient(135deg,rgba(108,29,69,.9) 0%,rgba(139,36,80,.86) 45%,rgba(108,29,69,.9) 100%);overflow:hidden}
    .nav-tabs{ display:flex; gap:8px; background:rgba(255,255,255,.14); border:1px solid rgba(255,255,255,.35); border-radius:14px; padding:6px; flex-wrap:wrap }
    .nav-tab{ flex:1; min-width:120px; padding:10px 14px; border-radius:10px; border:1px solid rgba(255,255,255,.35); color:#fff; background:transparent; cursor:pointer; font-weight:600; text-align:center; transition:all .3s ease }
    .nav-tab.active{ background:linear-gradient(135deg,var(--gold),var(--gold2)); color:var(--maroon); transform:scale(1.02) }
    .card{ background:#fff; border:1px solid var(--line); border-radius:18px; transition:all .3s ease } .card:hover{ transform:translateY(-2px); box-shadow:0 20px 40px rgba(0,0,0,.1) }
    .interactive-row{ border:1px solid var(--line); border-radius:12px; padding:12px 16px; display:flex; align-items:center; justify-content:space-between; gap:12px; background:#fff; transition:all .3s ease; cursor:pointer; position:relative; overflow:hidden }
    .interactive-row::before{ content:""; position:absolute; left:-100%; top:0; bottom:0; width:4px; background:linear-gradient(135deg,var(--gold),var(--maroon)); transition:left .3s ease }
    .interactive-row:hover{ transform:translateX(4px); box-shadow:0 12px 28px rgba(0,0,0,.08) } .interactive-row:hover::before{ left:0 }
    iframe.lesson-frame{width:100%;height:60vh;border:1px solid var(--line);border-radius:14px}
    textarea.code{ min-height:220px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; border:1px solid var(--line); border-radius:12px; padding:12px }
    
    /* Notification Styles */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 12px;
      animation: slideIn 0.3s ease;
      z-index: 9999;
    }
    @keyframes slideIn {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .notification.success { background: var(--ok); color: white; }
    .notification.error { background: #dc2626; color: white; }
    .notification.info { background: var(--blue); color: white; }
    .notification.warning { background: var(--soon); color: white; }
    
    /* Loading spinner */
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
<header class="hero">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex items-center justify-between py-6">
      <div class="flex items-center gap-4">
        <div class="w-16 h-16 bg-[var(--maroon)] rounded-lg flex items-center justify-center text-white font-bold text-xl">QLA</div>
        <div><h1 class="text-3xl lg:text-5xl font-extrabold" style="font-family:Poppins,Inter,sans-serif">Teacher Portal</h1><p class="text-sm opacity-90 mt-1">Qatar Leadership Academy</p></div>
      </div>
      <div class="hidden lg:flex items-center gap-4"><div class="bg-white/10 backdrop-blur rounded-full p-2"><i class="fas fa-user-tie text-2xl"></i></div>
        <div class="text-right"><div class="font-semibold">Teacher</div><div class="text-xs opacity-80" id="teacherEmail">—</div></div></div>
    </div>
    <div class="pb-6 nav" role="tablist">
      <button class="nav-tab active" data-tab="lessons"><i class="fas fa-book mr-2"></i>Lessons</button>
      <button class="nav-tab" data-tab="create"><i class="fas fa-plus mr-2"></i>Create Lesson</button>
      <button class="nav-tab" data-tab="assign"><i class="fas fa-tasks mr-2"></i>Assignments</button>
      <button class="nav-tab" data-tab="classes"><i class="fas fa-users mr-2"></i>Classes</button>
      <button class="nav-tab" data-tab="live"><i class="fas fa-chalkboard-teacher mr-2"></i>Classroom Mode</button>
      <button class="nav-tab" data-tab="analytics"><i class="fas fa-chart-simple mr-2"></i>Analytics</button>
      <a class="nav-tab" href="#" onclick="logout()"><i class="fas fa-sign-out-alt mr-2"></i>Sign out</a>
    </div>
  </div>
</header>

<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <section id="lessons-tab" class="tab-content">
    <div class="card p-5 mb-4">
      <div class="flex items-center justify-between">
        <div class="font-bold"><i class="fas fa-book mr-2 text-[var(--maroon)]"></i>My Lessons</div>
        <div class="flex items-center gap-3"><input id="searchLessons" class="rounded-lg border px-3 py-2" placeholder="Search by title"/></div>
      </div>
    </div>
    <div id="lessonsList" class="grid gap-4 md:grid-cols-2"></div>
  </section>

  <section id="create-tab" class="tab-content hidden">
    <div class="grid gap-6 md:grid-cols-2">
      <div class="card p-6">
        <h3 class="font-bold text-lg mb-4"><i class="fas fa-pen-to-square mr-2 text-[var(--gold)]"></i>Lesson Details</h3>
        <div class="grid gap-3">
          <label class="text-sm">
            Title <span class="text-red-500">*</span>
            <input id="title" class="rounded-lg border px-3 py-2 w-full" placeholder="e.g., Introduction to Fractions" required/>
          </label>
          <div class="grid grid-cols-3 gap-3">
            <label class="text-sm">
              Grade <span class="text-red-500">*</span>
              <select id="grade" class="rounded-lg border px-3 py-2 w-full">
                <option value="7">7</option>
                <option value="8">8</option>
              </select>
            </label>
            <label class="text-sm">
              Unit <span class="text-red-500">*</span>
              <input id="unit" type="number" min="1" max="20" class="rounded-lg border px-3 py-2 w-full" value="1"/>
            </label>
            <label class="text-sm">
              Order <span class="text-red-500">*</span>
              <input id="order" type="number" min="1" max="50" class="rounded-lg border px-3 py-2 w-full" value="1"/>
            </label>
          </div>
          <label class="text-sm">
            Description
            <input id="description" class="rounded-lg border px-3 py-2 w-full" placeholder="Brief description of the lesson"/>
          </label>
        </div>
      </div>
      <div class="card p-6">
        <h3 class="font-bold text-lg mb-4"><i class="fas fa-video mr-2 text-[var(--gold)]"></i>Video</h3>
        <div class="grid gap-3">
          <label class="text-sm">
            Video URL
            <input id="videoUrl" class="rounded-lg border px-3 py-2 w-full" placeholder="https://youtube.com/watch?v=..."/>
          </label>
          <div class="text-center text-sm text-slate-600">— or —</div>
          <label class="text-sm">
            Upload Video
            <input id="videoFile" type="file" accept="video/*" class="rounded-lg border px-3 py-2 w-full"/>
          </label>
          <button class="bg-[var(--maroon)] text-white px-4 py-2 rounded-lg hover:bg-[var(--maroon2)]" onclick="uploadVideo()">
            <i class="fas fa-upload mr-2"></i>Upload
          </button>
          <div id="videoUploadResult" class="text-sm text-slate-600"></div>
        </div>
      </div>
    </div>
    <div class="card p-6 mt-6">
      <h3 class="font-bold text-lg mb-2"><i class="fas fa-code mr-2 text-[var(--gold)]"></i>Lesson HTML (interactive)</h3>
      <p class="text-sm text-slate-600 mb-3">Paste or write your interactive HTML content. You can include JavaScript for interactivity.</p>
      <textarea id="htmlContent" class="code w-full" placeholder="Paste or author your interactive HTML (include inputs, buttons, scripts).

Example:
<h1>Welcome to the lesson!</h1>
<p>This is an interactive lesson.</p>
<button onclick='alert(&quot;Hello!&quot;)'>Click me</button>"></textarea>
      <div class="mt-4 flex items-center gap-3">
        <button id="saveLessonBtn" class="bg-[var(--ok)] text-white px-6 py-2 rounded-lg hover:opacity-80" onclick="saveLesson()">
          <i class="fas fa-save mr-2"></i>Save Lesson
        </button>
        <button id="previewBtn" class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700" onclick="previewHTML()">
          <i class="fas fa-eye mr-2"></i>Preview
        </button>
        <button class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700" onclick="clearForm()">
          <i class="fas fa-eraser mr-2"></i>Clear Form
        </button>
      </div>
      <div id="previewWrap" class="mt-4 hidden">
        <h4 class="font-bold mb-2">Preview:</h4>
        <iframe id="previewFrame" class="lesson-frame" srcdoc="<p>Preview will appear here</p>"></iframe>
      </div>
    </div>
  </section>

  <section id="assign-tab" class="tab-content hidden">
    <div class="card p-6">
      <h3 class="font-bold text-lg mb-4"><i class="fas fa-list-check mr-2 text-[var(--gold)]"></i>Create Assignment</h3>
      <div class="grid gap-3 md:grid-cols-2">
        <label class="text-sm">Select Lesson <select id="assignLesson" class="rounded-lg border px-3 py-2 w-full"></select></label>
        <label class="text-sm">Class Code <input id="classCode" class="rounded-lg border px-3 py-2 w-full" placeholder="e.g., MATH7A"/></label>
        <label class="text-sm">Pass % <input id="passPct" type="number" min="0" max="100" value="70" class="rounded-lg border px-3 py-2 w-full"/></label>
        <label class="text-sm">Due Date <input id="dueDate" type="date" class="rounded-lg border px-3 py-2 w-full"/></label>
      </div>
      <div class="mt-4"><button class="bg-[var(--maroon)] text-white px-6 py-2 rounded-lg hover:bg-[var(--maroon2)]" onclick="createAssignment()">Assign</button></div>
      <div id="assignResult" class="text-sm text-slate-600 mt-3"></div>
    </div>
    <div class="card p-6 mt-6">
      <h3 class="font-bold text-lg mb-4"><i class="fas fa-table mr-2 text-[var(--gold)]"></i>Assignments</h3>
      <div id="assignmentsList" class="space-y-2"></div>
    </div>
  </section>

  <section id="classes-tab" class="tab-content hidden">
    <div class="card p-6 mb-6">
      <h3 class="font-bold text-lg mb-3"><i class="fas fa-users mr-2 text-[var(--gold)]"></i>Create Class</h3>
      <div class="grid md:grid-cols-4 gap-3">
        <input id="ccode" placeholder="Code (e.g., MATH7A)" class="rounded border px-3 py-2"/>
        <input id="cname" placeholder="Name (e.g., Grade 7 A)" class="rounded border px-3 py-2"/>
        <input id="cgrade" type="number" min="1" max="12" value="7" class="rounded border px-3 py-2"/>
        <button class="bg-[var(--maroon)] text-white px-4 py-2 rounded" onclick="createClass()">Create</button>
      </div>
    </div>
    <div class="card p-6">
      <h3 class="font-bold text-lg mb-3">My Classes</h3>
      <div id="myClasses" class="space-y-3"></div>
    </div>
  </section>

  <section id="live-tab" class="tab-content hidden">
    <div class="card p-6">
      <h3 class="font-bold text-lg mb-4"><i class="fas fa-broadcast-tower mr-2 text-[var(--gold)]"></i>Presentation</h3>
      <div class="grid gap-3 md:grid-cols-2">
        <label class="text-sm">Class Code <input id="liveCode" class="rounded-lg border px-3 py-2 w-full" value="MATH7A"/></label>
        <label class="text-sm">Grade <select id="liveGrade" class="rounded-lg border px-3 py-2 w-full"><option>7</option><option>8</option></select></label>
        <label class="text-sm md:col-span-2">Go to Lesson ID <input id="liveLessonId" class="rounded-lg border px-3 py-2 w-full" placeholder="e.g., 7-1-2"/></label>
      </div>
      <div class="mt-4 flex items-center gap-3">
        <button class="bg-[var(--blue)] text-white px-6 py-2 rounded-lg hover:opacity-90" onclick="startBroadcast()">Start</button>
        <button class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700" onclick="sendGoto()">Send: Go To Lesson</button>
      </div>
      <div id="liveLog" class="mt-4 text-sm text-slate-600"></div>
    </div>
  </section>

  <section id="analytics-tab" class="tab-content hidden">
    <div class="card p-6"><h3 class="font-bold text-lg mb-2"><i class="fas fa-chart-simple mr-2 text-[var(--gold)]"></i>Overview</h3>
      <p class="text-slate-600">Assignment completion and assessment results will appear here.</p></div>
  </section>
</main>

<script>
const socket = typeof io !== 'undefined' ? io() : null;

// Notification system
function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  
  const icon = {
    success: 'fa-check-circle',
    error: 'fa-times-circle',
    warning: 'fa-exclamation-triangle',
    info: 'fa-info-circle'
  }[type] || 'fa-info-circle';
  
  notification.innerHTML = `<i class="fas ${icon}"></i><span>${message}</span>`;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.animation = 'slideIn 0.3s ease reverse';
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}

// API helper with better error handling
async function api(path, opts) {
  try {
    const response = await fetch(path, {
      headers: { 'Content-Type': 'application/json' },
      ...opts
    });
    
    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(errorText || `HTTP ${response.status}`);
    }
    
    return await response.json();
  } catch (error) {
    console.error('API Error:', error);
    throw error;
  }
}

// Tab switching
function switchTab(tab) {
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.toggle('hidden', !c.id.startsWith(tab)));
}

document.querySelectorAll('.nav-tab').forEach(b => b.addEventListener('click', () => switchTab(b.dataset.tab)));

// Load user info
async function me() {
  try {
    const r = await api('/api/auth/me');
    document.getElementById('teacherEmail').textContent = r.user?.email || '—';
  } catch (error) {
    console.error('Failed to load user info:', error);
  }
}

// Load lessons
async function loadLessons() {
  try {
    const r = await api('/api/lessons/catalog?all=1');
    const list = document.getElementById('lessonsList');
    const sel = document.getElementById('assignLesson');
    
    list.innerHTML = '';
    sel.innerHTML = '<option value="">-- Select a lesson --</option>';
    
    (r.units || []).forEach(u => (u.lessons || []).forEach(L => {
      const card = document.createElement('div');
      card.className = 'card p-4';
      card.innerHTML = `
        <div class="font-semibold mb-1">${L.title}</div>
        <div class="text-sm text-slate-600">Grade ${L.grade} • Unit ${L.unit} • Order ${L.order}</div>
        <div class="mt-2 flex items-center gap-2">
          <a class="bg-[var(--blue)] text-white px-3 py-1 rounded" target="_blank" href="${L.src}">
            <i class="fas fa-external-link-alt mr-1"></i>Preview
          </a>
          <button class="bg-[var(--maroon)] text-white px-3 py-1 rounded" onclick="editLesson(${L.id})">
            <i class="fas fa-edit mr-1"></i>Edit
          </button>
          <button class="bg-red-600 text-white px-3 py-1 rounded" onclick="deleteLesson(${L.id})">
            <i class="fas fa-trash mr-1"></i>Delete
          </button>
        </div>
      `;
      list.appendChild(card);
      
      const opt = document.createElement('option');
      opt.value = L.id;
      opt.textContent = `${L.title} (G${L.grade} U${L.unit} L${L.order})`;
      sel.appendChild(opt);
    }));
  } catch (error) {
    showNotification('Failed to load lessons', 'error');
  }
}

// Save lesson with better feedback
async function saveLesson() {
  const btn = document.getElementById('saveLessonBtn');
  const originalContent = btn.innerHTML;
  
  try {
    // Validate required fields
    const title = document.getElementById('title').value.trim();
    const grade = parseInt(document.getElementById('grade').value);
    const unit = parseInt(document.getElementById('unit').value);
    const order = parseInt(document.getElementById('order').value);
    
    if (!title) {
      showNotification('Please enter a lesson title', 'warning');
      document.getElementById('title').focus();
      return;
    }
    
    if (!unit || unit < 1 || unit > 20) {
      showNotification('Unit must be between 1 and 20', 'warning');
      document.getElementById('unit').focus();
      return;
    }
    
    if (!order || order < 1 || order > 50) {
      showNotification('Order must be between 1 and 50', 'warning');
      document.getElementById('order').focus();
      return;
    }
    
    // Show loading state
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Saving...';
    
    const payload = {
      title: title,
      grade: grade,
      unit: unit,
      lesson_order: order,
      description: document.getElementById('description').value.trim() || null,
      video_url: document.getElementById('videoUrl').value.trim() || null,
      html_content: document.getElementById('htmlContent').value.trim() || null
    };
    
    console.log('Saving lesson:', payload);
    
    const result = await api('/api/lessons', {
      method: 'POST',
      body: JSON.stringify(payload)
    });
    
    console.log('Lesson saved:', result);
    
    showNotification(`Lesson "${title}" saved successfully!`, 'success');
    
    // Clear form after successful save
    clearForm();
    
    // Reload lessons list
    await loadLessons();
    
    // Switch to lessons tab to show the new lesson
    switchTab('lessons');
    
  } catch (error) {
    console.error('Save error:', error);
    showNotification(`Failed to save lesson: ${error.message}`, 'error');
  } finally {
    // Restore button state
    btn.disabled = false;
    btn.innerHTML = originalContent;
  }
}

// Preview HTML with better handling
function previewHTML() {
  const html = document.getElementById('htmlContent').value;
  
  if (!html.trim()) {
    showNotification('Please enter some HTML content to preview', 'warning');
    return;
  }
  
  const frame = document.getElementById('previewFrame');
  const wrap = document.getElementById('previewWrap');
  
  // Show preview section
  wrap.classList.remove('hidden');
  
  // Set iframe content with lesson bridge script
  frame.srcdoc = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <title>Preview</title>
      <script src="https://cdn.tailwindcss.com"><\/script>
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    </head>
    <body style="padding: 20px;">
      ${html}
      <script src="/js/lesson-bridge.js"><\/script>
    </body>
    </html>
  `;
  
  // Scroll to preview
  wrap.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  
  showNotification('Preview updated', 'info');
}

// Clear form
function clearForm() {
  document.getElementById('title').value = '';
  document.getElementById('grade').value = '7';
  document.getElementById('unit').value = '1';
  document.getElementById('order').value = '1';
  document.getElementById('description').value = '';
  document.getElementById('videoUrl').value = '';
  document.getElementById('htmlContent').value = '';
  document.getElementById('videoFile').value = '';
  document.getElementById('previewWrap').classList.add('hidden');
  showNotification('Form cleared', 'info');
}

// Edit lesson
async function editLesson(id) {
  const title = prompt('Enter new title (leave blank to cancel):');
  if (!title || !title.trim()) return;
  
  try {
    await api('/api/lessons/' + id, {
      method: 'PUT',
      body: JSON.stringify({ title: title.trim() })
    });
    
    showNotification('Lesson updated successfully', 'success');
    await loadLessons();
  } catch (error) {
    showNotification('Failed to update lesson', 'error');
  }
}

// Delete lesson
async function deleteLesson(id) {
  if (!confirm('Are you sure you want to delete this lesson? This action cannot be undone.')) return;
  
  try {
    await api('/api/lessons/' + id, { method: 'DELETE' });
    showNotification('Lesson deleted successfully', 'success');
    await loadLessons();
  } catch (error) {
    showNotification('Failed to delete lesson', 'error');
  }
}

// Upload video
async function uploadVideo() {
  const file = document.getElementById('videoFile').files[0];
  if (!file) {
    showNotification('Please select a video file', 'warning');
    return;
  }
  
  try {
    const formData = new FormData();
    formData.append('video', file);
    
    const response = await fetch('/api/uploads/video', {
      method: 'POST',
      body: formData
    });
    
    if (!response.ok) throw new Error('Upload failed');
    
    const result = await response.json();
    document.getElementById('videoUrl').value = result.url;
    document.getElementById('videoUploadResult').textContent = 'Uploaded: ' + result.url;
    showNotification('Video uploaded successfully', 'success');
  } catch (error) {
    showNotification('Failed to upload video', 'error');
  }
}

// Create assignment
async function createAssignment() {
  try {
    const payload = {
      lesson_id: document.getElementById('assignLesson').value,
      class_code: document.getElementById('classCode').value,
      pass_pct: parseInt(document.getElementById('passPct').value) || 70,
      due_at: document.getElementById('dueDate').value || null
    };
    
    if (!payload.lesson_id) {
      showNotification('Please select a lesson', 'warning');
      return;
    }
    
    if (!payload.class_code) {
      showNotification('Please enter a class code', 'warning');
      return;
    }
    
    const result = await api('/api/assignments', {
      method: 'POST',
      body: JSON.stringify(payload)
    });
    
    document.getElementById('assignResult').textContent = `Assigned to ${result.class_code} (pass ${result.pass_pct}%)`;
    showNotification('Assignment created successfully', 'success');
    await loadAssignments();
  } catch (error) {
    showNotification('Failed to create assignment', 'error');
  }
}

// Load assignments
async function loadAssignments() {
  try {
    const assignments = await api('/api/assignments');
    const list = document.getElementById('assignmentsList');
    list.innerHTML = '';
    
    assignments.forEach(a => {
      const div = document.createElement('div');
      div.className = 'interactive-row';
      div.innerHTML = `
        <div>
          <div class="font-semibold">Lesson ${a.lesson_id} → ${a.class_code}</div>
          <div class="text-sm text-slate-600">Due: ${a.due_at || '—'} • Pass: ${a.pass_pct}%</div>
        </div>
        <span class="status">Active</span>
      `;
      list.appendChild(div);
    });
  } catch (error) {
    showNotification('Failed to load assignments', 'error');
  }
}

// Load classes
async function loadMyClasses() {
  try {
    const classes = await api('/api/classes');
    const list = document.getElementById('myClasses');
    list.innerHTML = '';
    
    classes.forEach(c => {
      const div = document.createElement('div');
      div.className = 'interactive-row';
      div.innerHTML = `
        <div>
          <div class="font-semibold">${c.name}</div>
          <div class="text-xs text-slate-600">${c.code} • Grade ${c.grade || '-'} • ${c.students || 0} student(s)</div>
        </div>
        <button class="status open" onclick="enrollStudent(${c.id})">Add Student</button>
      `;
      list.appendChild(div);
    });
  } catch (error) {
    showNotification('Failed to load classes', 'error');
  }
}

// Enroll student
async function enrollStudent(classId) {
  const email = prompt('Enter student email to enroll:');
  if (!email) return;
  
  try {
    await api('/api/classes/' + classId + '/enroll', {
      method: 'POST',
      body: JSON.stringify({ student_email: email })
    });
    
    showNotification('Student enrolled successfully', 'success');
    await loadMyClasses();
  } catch (error) {
    showNotification('Failed to enroll student', 'error');
  }
}

// Create class
async function createClass() {
  try {
    const payload = {
      code: document.getElementById('ccode').value,
      name: document.getElementById('cname').value,
      grade: parseInt(document.getElementById('cgrade').value) || null
    };
    
    if (!payload.code || !payload.name) {
      showNotification('Please enter class code and name', 'warning');
      return;
    }
    
    await api('/api/classes', {
      method: 'POST',
      body: JSON.stringify(payload)
    });
    
    showNotification('Class created successfully', 'success');
    await loadMyClasses();
    
    // Clear inputs
    document.getElementById('ccode').value = '';
    document.getElementById('cname').value = '';
  } catch (error) {
    showNotification('Failed to create class', 'error');
  }
}

// Classroom mode functions
function startBroadcast() {
  const code = document.getElementById('liveCode').value;
  if (!code) {
    showNotification('Please enter a class code', 'warning');
    return;
  }
  
  if (socket) {
    socket.emit('class:start', { code });
    document.getElementById('liveLog').innerHTML += `<div>• Started broadcast for ${code}</div>`;
    showNotification('Broadcast started', 'success');
  } else {
    showNotification('WebSocket not connected', 'error');
  }
}

function sendGoto() {
  const code = document.getElementById('liveCode').value;
  const grade = parseInt(document.getElementById('liveGrade').value);
  const lessonId = document.getElementById('liveLessonId').value;
  
  if (!code || !lessonId) {
    showNotification('Please enter class code and lesson ID', 'warning');
    return;
  }
  
  if (socket) {
    socket.emit('class:event', {
      code,
      action: 'gotoLesson',
      grade,
      lessonId,
      title: 'Live lesson',
      ts: Date.now()
    });
    
    document.getElementById('liveLog').innerHTML += `<div>• Sent students to lesson ${lessonId}</div>`;
    showNotification('Command sent to students', 'success');
  } else {
    showNotification('WebSocket not connected', 'error');
  }
}

// Logout
async function logout() {
  try {
    await fetch('/auth/logout', { method: 'POST' });
    window.location.href = '/login';
  } catch (error) {
    console.error('Logout error:', error);
    window.location.href = '/login';
  }
}

// Initialize on load
async function init() {
  try {
    await me();
    await loadLessons();
    await loadAssignments();
    await loadMyClasses();
    showNotification('Portal loaded successfully', 'success');
  } catch (error) {
    console.error('Initialization error:', error);
    showNotification('Some features may not be available', 'warning');
  }
}

// Add keyboard shortcuts
document.addEventListener('keydown', (e) => {
  // Ctrl+S to save lesson
  if (e.ctrlKey && e.key === 's' && !document.getElementById('create-tab').classList.contains('hidden')) {
    e.preventDefault();
    saveLesson();
  }
  // Ctrl+P to preview
  if (e.ctrlKey && e.key === 'p' && !document.getElementById('create-tab').classList.contains('hidden')) {
    e.preventDefault();
    previewHTML();
  }
});

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
